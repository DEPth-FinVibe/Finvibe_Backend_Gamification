package depth.finvibe.gamification.modules.gamification.infra.scheduler;

import lombok.RequiredArgsConstructor;

import net.javacrumbs.shedlock.spring.annotation.SchedulerLock;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import depth.finvibe.gamification.modules.gamification.application.port.in.ChallengeCommandUseCase;
import depth.finvibe.gamification.modules.gamification.application.port.in.MetricCommandUseCase;
import depth.finvibe.gamification.modules.gamification.application.port.in.XpCommandUseCase;

@Component
@RequiredArgsConstructor
/**
 * KST 기준으로 주간 갱신 배치 작업을 실행합니다.
 */
public class GamificationScheduler {

    private final ChallengeCommandUseCase challengeCommandUseCase;
    private final MetricCommandUseCase metricCommandUseCase;
    private final XpCommandUseCase xpCommandUseCase;

    /**
     * 매주 월요일 00:00에 스쿼드 랭킹을 정산하고 주간 XP를 초기화합니다.
     */
    @Scheduled(cron = "0 0 0 * * MON", zone = "Asia/Seoul")
    @SchedulerLock(name = "gamification_updateWeeklySquadRanking", lockAtMostFor = "PT30M")
    public void updateWeeklySquadRanking() {
        xpCommandUseCase.updateWeeklySquadRanking();
    }

    /**
     * 매주 일요일 23:55에 개인 챌린지 보상을 지급합니다.
     */
    @Scheduled(cron = "0 55 23 * * SUN", zone = "Asia/Seoul")
    @SchedulerLock(name = "gamification_rewardPersonalChallenges", lockAtMostFor = "PT30M")
    public void rewardPersonalChallenges() {
        challengeCommandUseCase.rewardPersonalChallenges();
    }

    /**
     * 매주 일요일 23:58에 주간 이벤트 보상을 지급합니다.
     */
    @Scheduled(cron = "0 58 23 * * SUN", zone = "Asia/Seoul")
    @SchedulerLock(name = "gamification_rewardWeeklyChallenges", lockAtMostFor = "PT30M")
    public void rewardWeeklyChallenges() {
        challengeCommandUseCase.rewardWeeklyChallenges();
    }

    /**
     * 매주 월요일 00:05에 개인 챌린지를 생성합니다.
     */
    @Scheduled(cron = "0 5 0 * * MON", zone = "Asia/Seoul")
    @SchedulerLock(name = "gamification_generatePersonalChallenges", lockAtMostFor = "PT30M")
    public void generatePersonalChallenges() {
        metricCommandUseCase.resetWeeklyMetrics();
        challengeCommandUseCase.generatePersonalChallenges();
    }
}
